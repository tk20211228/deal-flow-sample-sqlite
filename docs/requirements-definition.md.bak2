# 物上げ業務管理システム 要件定義書

## 1. ビジネスモデルの理解

### 1.1 事業概要

- **事業内容**: 1R投資用マンション（賃貸マンション）の仲介業務
- **特徴**: 「物上げ」と呼ばれる、既存オーナーに対する売却促進営業
- **営業手法**: テレアポによる相場以下での売却交渉
- **収益源**: 相場以下での仕入れと市場価格での売却による差益

### 1.2 取引構造と関係者

#### 1.2.1 関係者の定義

```
A: 物件所有者（売主）
B: グループ会社（形式上の買主、実質は弊社）
C: 買取再販業者
D: エンド（最終購入者、一般買主）
仲介: レイジット（弊社）
```

#### 1.2.2 取引フロー

```
[A 所有者] → AB契約 → [B グループ会社] → BC契約 → [C 買取業者] → CD契約 → [D エンド]
        ↑
     仲介（レイジット）が売却アプローチ・契約サポート
```

### 1.3 利益構造（重要）

#### 1.3.1 実例による利益計算
```
【取引例】
AB間: 売買代金 1,000万円 + 仲介手数料 39.6万円（Aから受領）
BC間: 売買代金 1,200万円（仲介手数料込み）
CD間: 売買代金 1,500万円（参考）

【利益計算】
弊社利益 = BC売買代金 - AB売買代金 + AB仲介手数料
        = 1,200万円 - 1,000万円 + 39.6万円
        = 239.6万円

C業者利益 = 1,500万円 - 1,200万円 = 300万円（管理対象外）
```

#### 1.3.2 利益計算式の定義

```
利益 = 出口金額（BC間） - A金額（AB間） + 仲手等（AB間の仲介手数料）
```

**重要**: 仲手等は弊社の「収入」であるため、利益に「加算」される

### 1.4 業務フローの詳細

#### 1.4.1 基本的な業務の流れ

1. **マイソク作成・業者配布**: 物件資料作成と買取業者への一括配布
2. **AB間売買契約締結**: 所有者との売買契約（①と前後する場合あり）
3. **物件調査**:
   - 建物管理書類（重調・管理規約・長計）
   - 賃貸管理書類（賃契・管理委託契約書）
   - 役所書類（公課証明・建築概要）
4. **BC契約書・重説作成**: 最高値業者との契約準備
5. **精算書作成**: 決済日確定後の精算書作成
6. **司法書士依頼**: 登記手続きの依頼
7. **賃貸管理解約**: 家賃送金切替手続き
8. **決済実行**: 金銭授受と物件引渡し

#### 1.4.2 業者ステータスの遷移

```
未仕入れ（水色）: AB契約前の金額確認段階
    ↓
書類待ち（😭）: AB契約済だが必要書類待ち
    ↓
業者確定待ち（▲）: 業者との価格交渉中
    ↓
確定（〇）: 業者確定済み
```

### 1.5 売上計上ルール

#### 1.5.1 基本ルール

- **原則**: AB契約月の翌月末までにC確定 → 契約月に計上
- **例外**: 翌月末以降にC確定 → 確定月の前月に計上

#### 1.5.2 計上例

```
8/15 AB契約 → 8/30 C確定  = 8月計上
8/15 AB契約 → 9/27 C確定  = 8月計上
8/15 AB契約 → 10/3 C確定  = 9月計上
8/15 AB契約 → 11/30 C確定 = 10月計上
```

#### 1.5.3 特殊ケース

- **違約金**: 入金月に計上
- **弁護士案件**: 解決後、通常ルールで計上

## 2. プロジェクト概要

### 2.1 システム名称

物上げ業務管理システム（Deal Flow Management System）

### 2.2 システムの目的

1R投資用マンションの物上げビジネスにおける事務作業・管理業務の効率化と自動化を実現し、現在のスプレッドシート・Evernote管理から脱却する。

### 2.3 解決すべき課題

- 手動管理による誤操作・データ消失リスク
- 複数ツール間のデータ連携の非効率性
- 進捗状況の可視化不足
- 日付トラッキングの欠如
- アラート機能の不在による抜け漏れ
- 営業と事務間の連携非効率

### 2.4 技術スタック

- **フレームワーク**: Next.js 14 (App Router)
- **データベース**: Turso (SQLite Edge Database)
- **ORM**: Drizzle ORM
- **認証**: Better Auth
- **ホスティング**: Vercel
- **スタイリング**: Tailwind CSS
- **UIコンポーネント**: shadcn/ui

## 3. 機能要件（MVP）

### 3.1 優先度1: 決済確定管理機能

#### 2.1.1 基本機能
- 案件情報の登録・編集・削除
- 25項目の管理（担当、物件名、A金額、出口金額、仲手、利益、契約形態等）
- ステータス管理（BC未確定→BC確定→決済完了）
- 利益計算の自動化

#### 2.1.2 管理項目（全28項目）
```
基本情報：
- 担当
- 物件名
- 号室
- オーナー名
- 名簿種別

金額情報：
- A金額（AB間売買価格）
- 出口金額（BC間売買価格）
- 仲手等（合計）
- 利益（自動計算：出口金額 - A金額 + 仲手等）
- BC手付

契約情報：
- 契約形態
- A契約日（AB契約日）
- BC契約日
- 決済日

関係者情報：
- 買取業者
- B会社
- 仲介会社
- 抵当銀行

口座管理：
- レイジット口座
- ライフ口座
- エムズ口座

その他管理項目：
- 所変
- 口振
- 送付
- 勤務先DM
- 取引台帳
- 管理解約
- 備考
```

#### 2.1.3 案件管理ページ機能
- **表示最適化**: 文字サイズ小（text-sm）で15項目を横スクロール対応テーブルに表示
  - 表示項目（左から順）: 担当/物件名/オーナー名/A金額/出口金額/仲手等/利益/決済日/買取業者/契約形態/B会社/仲介会社/業者ステータス/書類ステータス/備考
- **ページ分割**:
  - 決済月別にページを切り替え
  - 決済済みページ（決済完了した月）
  - 決済未完了ページ（業者確定前ページ/業者確定後ページに分割）
- **集計表示**:
  - 当月の利益合計・BC手付合計をヘッダーに常時表示
- **口座管理**:
  - B会社口座選択後、該当物件の出口金額合計を決済日ごとに表示
  - 1日1億円の振込上限警告（口座別の決済日ごと集計）
- **インライン編集**:
  - 備考欄・ステータスの直接編集機能
- **監査ログ**:
  - 全項目の変更履歴（ユーザー・日時・変更内容）を記録
  - どのアカウントがいつどのような事を入力・保存したかを閲覧可能

#### 2.1.4 業者ステータス管理（7段階）
1. BC確定前（業者確定前ページ）
2. BC確定 CB待ち（業者確定後ページへ自動移動）
3. BC確定 契約待ち
4. BC完了 決済日確定待ち
5. 決済日確定 精算書待ち
6. 精算書完了 決済待ち
7. 決済完了

#### 2.1.5 書類ステータス管理（3段階）
1. 書類依頼待ち
2. 書類取得中
3. 全書類取得完了

#### 2.1.6 入力方式定義
- **プルダウン選択**: 担当、契約形態、B会社、仲介会社（項目追加可能）
- **オートコンプリート**: 買取業者、抵当銀行（検索サジェスト付き手入力も可）
- **日付入力**: 曜日自動表示、「○月予定」形式も入力可能
- **自動計算**: 利益 = 出口金額 - A金額 + 仲手等

#### 2.1.7 案件詳細ページ機能

- **全画面表示ビュー**: 全項目を一覧表示（閲覧用）
- **編集モード**: 項目ごとの詳細編集（現在の詳細ページ形式）
- **4タブ構成**:
  - 基本情報タブ
  - 契約進捗タブ（AB関係・BC関係）
  - 書類進捗タブ（物件調査書類）
  - 決済進捗タブ（決済関連・口座管理）

### 3.2 優先度2: 進捗管理機能

#### 2.2.1 基本機能
- 各工程の進捗状況をチェックボックスで管理
- 日付の自動記録
- 進捗率の可視化
- 遅延アラート機能

#### 2.2.2 管理工程（詳細）

**AB関係**
- 契約書 保存完了
- 委任状関係 保存完了
- 売主身分証 保存完了

**BC関係**
- BC売契作成
- 重説作成
- BC売契送付
- 重説送付
- BC売契CB完了
- 重説CB完了

**書類進捗**
- 空欄 → 依頼 → 取得完了（✅）または書類なし（❌）
- 各項目でチェック日時とアカウント名（苗字）を自動記録

### 3.3 優先度3: 調査関係管理機能

#### 2.3.1 基本機能
- 物件調査項目のチェックリスト管理
- 依頼日・取得日の記録
- 書類取得状況の可視化
- 営業への依頼アラート

#### 2.3.2 取得書類（詳細）

**賃貸管理関係**
- 賃貸借契約書
- 管理委託契約書

**建物管理関係**
- 重要事項調査報告書
- 管理規約
- 長期修繕計画書
- 総会議事録

**役所関係**
- 公課証明
- 建築計画概要書
- 台帳記載事項証明書
- 用途地域
- 道路台帳

**銀行関係**
- ローン計算書

※各書類：「空欄」→「依頼」→「取得完了✅」または「書類なし❌」の状態管理
※チェック時に日時とアカウント名（苗字）を自動記録

### 3.4 優先度4: BC契約管理機能

#### 2.4.1 基本機能
- BC契約の作成・送付・CB管理
- 契約締結状況の管理
- 業者別の契約履歴

#### 2.4.2 ステータス管理
- 新規作成
- 送付CB待ち
- 業者CB済
- 業者契約待ち
- 契約締結済み

### 3.5 優先度5: 精算書管理機能

#### 2.5.1 基本機能
- 精算書の作成・送付・CB管理
- ローン計算書の取得状況管理
- 売主用・買主用精算書の区分管理
- 決済月別の優先順位表示

#### 2.5.2 ステータス管理
- 新規作成
- 送付CB待ち
- CB済・売主用作成
- CR待ち
- CR済
- 決済済み

### 3.6 優先度6: 出口管理機能

#### 2.6.1 基本機能
- マイソク（物件資料）の作成・管理
- 業者への一括配布
- 金額回答の自動集計
- 最高値業者の自動判定

#### 2.6.2 ステータス管理
- 未仕入れ（水色）
- 書類待ち（😭）
- 業者確定待ち（▲）
- 確定（〇）

### 3.7 優先度7: 業者配布メール機能

#### 2.7.1 基本機能
- 業者への一括メール送信
- 金額回答フォーム（URL形式）
- 自動集計・ランキング表示
- 業者別の回答率・平均金額分析
- 過去データの蓄積・分析

### 3.8 優先度8: 決済進捗管理機能

#### 2.8.1 精算書関係
- **BC精算書**: 作成 → 送付 → CB完了
- **ローン計算書**: 保存（抵当銀行関係と連動）
- **AB精算書**: 作成 → 送付 → CR完了

#### 2.8.2 司法書士関係
- 司法書士依頼
- 必要書類共有
- **本人確認書類**: 発送 → 受け取り → 返送
- 書類不備なし確認

#### 2.8.3 抵当銀行関係
- **抵当銀行**: 依頼 → 受付完了
- 書類不備なし確認
- ローン計算書保存（精算書関係と連動）
- 売主手出し完了

#### 2.8.4 賃貸管理関係
- **管理解約依頼**: 依頼 → 完了

#### 2.8.5 決済後関係
- **保証会社承継**: 依頼 → 完了
- **鍵**: 受取 → 発送
- **管積 口座振替手続き**: 受取 → 発送
- 取引台帳記入

### 3.9 優先度9: 口座管理機能

#### 2.9.1 基本機能
- B会社口座別の決済管理
- 同一決済日の出口金額合計自動計算
- 1日1億円の振込上限警告機能
- 口座グループごとの項目追加機能

#### 2.9.2 口座種別

**レイジット口座**
- GMOメイン
- GMOサブ
- 住信
- 近産
※項目追加可能

**エムズ口座**
- GMOメイン
- GMOサブ
- 住信
- ペイペイ①
- ペイペイ②
- ペイペイ③
- 楽天①
- 楽天②
※項目追加可能

**ライフ口座**
- GMOメイン
- GMOサブ
※項目追加可能

## 4. 非機能要件

### 4.1 パフォーマンス要件
- ページ読み込み時間: 3秒以内
- データ検索: 1秒以内
- 同時接続ユーザー数: 50人以上

### 4.2 セキュリティ要件
- ユーザー認証・認可（Better Auth）
- HTTPSによる通信暗号化
- ロール別アクセス制御（管理者、営業、事務）
- 監査ログの記録（全項目の変更履歴）
- 変更履歴の自動記録（ユーザー・日時・変更内容）
- チェック/ステータス変更時のアカウント名（苗字）自動記録

### 4.3 可用性要件
- サービス稼働率: 99.5%以上
- Vercelの自動スケーリング活用
- データベースの自動バックアップ（日次）

### 4.4 ユーザビリティ要件
- レスポンシブデザイン対応
- 直感的なUI/UX
- キーボードショートカット対応
- 一括操作機能

## 5. システム構成

### 5.1 アーキテクチャ
```
┌─────────────┐     ┌──────────────┐     ┌────────────┐
│   Client    │────▶│  Next.js API │────▶│   Turso    │
│  (Browser)  │◀────│    Routes    │◀────│  Database  │
└─────────────┘     └──────────────┘     └────────────┘
                            │
                    ┌───────▼────────┐
                    │  Better Auth   │
                    └────────────────┘
```

### 5.2 データモデル（主要エンティティ）
- **物件（Property）**: 物件基本情報（物件名、号室、オーナー名等）
- **取引（Deal）**: AB間・BC間取引情報（金額、契約日、決済日等）
- **業者（Company）**: 買取業者・仲介会社情報
- **書類（Document）**: 各種書類の管理（依頼・取得状況）
- **進捗（Progress）**: 各工程の進捗状況
- **詳細進捗（DetailedProgress）**: 契約・書類・決済の詳細管理
- **ユーザー（User）**: システム利用者
- **監査ログ（AuditLog）**: 全項目の変更履歴
- **口座管理（BankAccount）**: B会社口座情報と振込上限管理

## 6. 画面構成（MVP）

### 6.1 主要画面
1. **ダッシュボード**: KPI表示、アラート一覧
2. **案件一覧**:
   - 月別・ステータス別フィルター
   - 業者確定前/確定後/決済済みの分類
   - インライン編集機能
3. **案件詳細**:
   - **全画面表示ビュー**: 全項目を一覧表示（閲覧用）
   - **編集モード**: 項目ごとの詳細編集
   - 4タブ構成（基本情報/契約進捗/書類進捗/決済進捗）
4. **進捗管理**: カンバン形式の進捗表示
5. **業者管理**: 業者情報・取引履歴
6. **レポート**: 売上分析・業者分析
7. **口座管理**: B会社口座別の振込管理

### 6.2 ユーザーロール
- **管理者**: 全機能へのアクセス、ユーザー管理
- **営業**: 案件登録、進捗確認、書類依頼
- **事務**: 書類作成、進捗更新、精算処理

## 7. 外部連携

### 7.1 現行システムとの連携
- スプレッドシートからのデータインポート機能
- Evernoteデータの移行ツール
- チャットワークへの通知連携（将来）

### 7.2 将来的な連携
- 司法書士とのデータ共有機能
- 銀行APIとの連携（ローン計算書自動取得）
- 不動産ポータルサイトとの連携

## 8. 売上計上ルール

### 8.1 計上タイミング
- **基本ルール**: AB契約月の翌月末までにC確定→契約月計上
- **例外ルール**: 翌月末以降にC確定→確定月の前月計上

### 8.2 特殊ケース
- **違約金**: 入金月に計上
- **弁護士案件**: 解決後、通常ルールで計上

## 9. 開発フェーズ（MVP）

### Phase 1（第1週）
- 環境構築・認証機能実装
- 決済確定管理機能

### Phase 2（第2週）
- 進捗管理機能
- 調査関係管理機能

### Phase 3（第3週）
- BC契約管理機能
- 精算書管理機能

### Phase 4（第4週）
- 出口管理機能
- 業者配布メール機能
- テスト・デプロイ

## 10. 成功指標（KPI）

### 10.1 業務効率化
- データ入力時間: 50%削減
- 進捗確認時間: 70%削減
- エラー・抜け漏れ: 80%削減

### 10.2 可視化向上
- リアルタイム進捗把握: 100%
- 売上予測精度: 90%以上
- 業者パフォーマンス分析: 即時

## 11. リスクと対策

### 11.1 技術的リスク
- **Tursoの制限**: エッジ環境での制約→キャッシュ戦略の実装
- **データ移行**: 既存データの整合性→段階的移行とバリデーション

### 11.2 業務的リスク
- **ユーザー教育**: 新システムへの抵抗→段階的導入と研修実施
- **並行運用**: 移行期間の二重管理→自動同期機能の実装

## 12. 将来の拡張性

### 12.1 機能拡張
- AI予測機能（成約確率、最適価格）
- 自動査定機能
- 営業支援機能（スクリプト生成）

### 12.2 事業拡張
- 複数物件タイプ対応
- グループ会社間連携
- 外部パートナー連携

## 13. 制約事項

### 13.1 MVP範囲
- 既存業務フローの大幅変更は行わない
- 外部システムとのリアルタイム連携は含まない
- モバイルアプリは含まない（PWA対応のみ）

### 13.2 技術的制約
- Vercelの無料枠制限を考慮
- Tursoの無料枠制限を考慮
- 初期開発は日本語UIのみ

---

**改訂履歴**
- v1.0 - 2025-01-27 - 初版作成
- v1.1 - 2025-01-28 - 顧客要望に基づく機能拡張
  - 案件管理ページの表示最適化と月別分割機能追加
  - 業者ステータス（7段階）と書類ステータス（3段階）の詳細定義
  - 案件詳細ページの全画面表示ビューと編集モード追加
  - 決済進捗管理機能と口座管理機能の新規追加
  - 監査ログと変更履歴機能の拡充
  - 入力方式（プルダウン、オートコンプリート、自動計算）の詳細定義