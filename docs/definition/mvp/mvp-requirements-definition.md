# MVP要件定義書

## バージョン情報

- **作成日**: 2025-10-14
- **バージョン**: 1.0
- **対象フェーズ**: MVP（Minimum Viable Product）

---

## 1. MVP概要

### 1.1 目的

1R投資用マンションの物上げ業務における案件管理を効率化するシステムのMVPを構築する。

### 1.2 MVP範囲

MVPでは以下の2つの主要機能に絞って実装する：

1. **認証・組織管理機能**
   - 組織単位でのデータ分離
   - ロールベースのアクセス制御
   - Better Authによる認証基盤

2. **案件管理機能**
   - 案件の登録・編集・削除
   - 進捗管理（業者ステータス・書類ステータス）
   - 案件一覧表示（BC確定前／月次）
   - 案件詳細表示

### 1.3 MVP範囲外（将来実装）

以下の機能はMVPでは実装せず、Phase 2以降で実装する：

- マイソク作成・業者配布機能
- 営業・事務員連携機能（依頼管理）
- 書類アップロード・管理機能
- アラート・リマインダー機能
- レポート・分析機能
- 外部システム連携

---

## 2. ビジネスモデルの理解

### 2.1 事業概要

- **主要業務**: 1R投資用マンションの物上げ（既存オーナーへの売却営業）
- **営業手法**: テレアポ
- **収益構造**: 相場以下での仕入れと適正価格での転売による差益

### 2.2 取引構造と関係者

```
A（所有者）→ B（グループ会社）→ C（買取再販業者）→ D（エンド）
           ↑
        仲介（レイジット）
```

- **A**: 所有者（売主）
- **B**: グループ会社（買取会社）
- **C**: 買取再販業者
- **D**: エンド（一般買主）
- **仲介**: レイジット（貴社）

### 2.3 利益構造

**利益計算式**:

```
利益 = 出口金額 - A金額 + 仲手等
```

**利益構造の例**:

- AB間: 売買代金 1,000万円 + 仲介手数料 39.6万円
- BC間: 売買代金 1,200万円（仲介手数料込み）
- 貴社利益: 239.6万円（差益200万円 + 仲介手数料39.6万円）

### 2.4 売上計上ルール

**基本ルール**: 当月に契約をした物件を翌月末日までにC業者を確定できれば、当月の売上として計上

**例**:
- 8月15日契約 → 9月27日にC確定 → 売上計上月: 8月
- 8月15日契約 → 10月3日にC確定 → 売上計上月: 9月

---

## 3. 認証・組織管理機能

### 3.1 機能概要

組織単位でデータを分離し、ロールベースでアクセスを制御する認証基盤を構築する。

### 3.2 組織（Organization）

#### 3.2.1 組織の定義

- 1つの会社または部門が1つの組織として登録される
- 各組織は独立したデータ空間を持つ
- 組織間でデータは共有されない

#### 3.2.2 組織の属性

| 属性 | 型 | 必須 | 説明 |
|------|-----|------|------|
| id | string | ● | 組織ID（UUID） |
| name | string | ● | 組織名 |
| slug | string | ● | 組織のスラッグ（URL用、一意） |
| createdAt | datetime | ● | 作成日時 |
| updatedAt | datetime | ● | 更新日時 |

#### 3.2.3 組織の作成

- 新規ユーザー登録時に組織を作成
- または既存組織に招待される

### 3.3 ユーザー（User）

#### 3.3.1 ユーザーの属性

| 属性 | 型 | 必須 | 説明 |
|------|-----|------|------|
| id | string | ● | ユーザーID（UUID） |
| email | string | ● | メールアドレス（一意） |
| name | string | ● | 氏名 |
| image | string | - | プロフィール画像URL |
| emailVerified | boolean | ● | メール認証済みフラグ |
| createdAt | datetime | ● | 作成日時 |
| updatedAt | datetime | ● | 更新日時 |

#### 3.3.2 認証方式

Better Authを使用し、以下の認証方式をサポート：

1. **メールアドレス + パスワード**
   - メール認証必須
   - パスワードリセット機能

2. **将来的にサポート予定**
   - Google OAuth
   - その他のOAuthプロバイダー

### 3.4 組織メンバー（Organization Member）

#### 3.4.1 メンバーの属性

| 属性 | 型 | 必須 | 説明 |
|------|-----|------|------|
| id | string | ● | メンバーID（UUID） |
| organizationId | string | ● | 組織ID |
| userId | string | ● | ユーザーID |
| role | string | ● | ロール（owner/admin/member） |
| createdAt | datetime | ● | 参加日時 |
| updatedAt | datetime | ● | 更新日時 |

#### 3.4.2 ユーザーと組織の関係

- 1人のユーザーは複数の組織に所属できる
- 組織ごとに異なるロールを持つことができる

### 3.5 ロール（Role）

#### 3.5.1 ロールの種類

MVPでは以下の3つのロールを定義：

| ロール | 説明 | 権限 |
|--------|------|------|
| owner | オーナー | 全ての操作が可能（組織削除、メンバー管理、案件管理） |
| admin | 管理者 | メンバー管理、案件管理が可能（組織削除は不可） |
| member | メンバー | 案件の閲覧・編集が可能（メンバー管理は不可） |

#### 3.5.2 ロール別の権限詳細

##### Owner（オーナー）

- 組織の削除
- 組織情報の編集
- メンバーの招待・削除
- メンバーのロール変更
- 案件の作成・編集・削除・閲覧

##### Admin（管理者）

- 組織情報の編集
- メンバーの招待・削除
- メンバーのロール変更（ownerへの変更は不可）
- 案件の作成・編集・削除・閲覧

##### Member（メンバー）

- 案件の作成・編集・削除・閲覧
- 自分の担当案件の管理

### 3.6 メンバー招待機能

#### 3.6.1 招待フロー

1. Owner/Adminがメールアドレスとロールを指定して招待を送信
2. 招待メールが送信される
3. 招待されたユーザーが招待リンクをクリック
4. 既存ユーザーの場合: ログイン後、組織に参加
5. 新規ユーザーの場合: アカウント作成後、組織に参加

#### 3.6.2 招待（Invitation）の属性

| 属性 | 型 | 必須 | 説明 |
|------|-----|------|------|
| id | string | ● | 招待ID（UUID） |
| organizationId | string | ● | 組織ID |
| email | string | ● | 招待先メールアドレス |
| role | string | ● | 招待時のロール |
| invitedBy | string | ● | 招待者のユーザーID |
| status | string | ● | ステータス（pending/accepted/expired） |
| expiresAt | datetime | ● | 有効期限（7日間） |
| createdAt | datetime | ● | 作成日時 |

### 3.7 セッション管理

#### 3.7.1 アクティブ組織の管理

- ユーザーが複数の組織に所属している場合、アクティブな組織を選択
- セッションにアクティブな組織IDを保存
- 画面上で組織を切り替え可能

#### 3.7.2 セッションの属性

Better Authのセッション管理を使用し、以下の情報を保持：

- userId
- activeOrganizationId
- expiresAt

### 3.8 認証画面

#### 3.8.1 ログイン画面

- メールアドレス + パスワードでログイン
- 「パスワードを忘れた方」リンク
- 「アカウントをお持ちでない方」リンク（サインアップへ）

#### 3.8.2 サインアップ画面

- 氏名、メールアドレス、パスワードを入力
- 組織名を入力（新規組織を作成）
- メール認証が必要

#### 3.8.3 パスワードリセット画面

- メールアドレスを入力
- リセットリンクをメールで送信
- リセットリンクから新しいパスワードを設定

#### 3.8.4 組織選択画面

- ユーザーが複数の組織に所属している場合に表示
- 組織一覧から選択
- 選択後、ダッシュボードへ遷移

#### 3.8.5 組織設定画面

- 組織情報の編集
- メンバー一覧表示
- メンバー招待機能
- メンバーのロール変更・削除機能

### 3.9 アクセス制御

#### 3.9.1 ミドルウェアによる保護

- 未認証ユーザーは認証画面にリダイレクト
- 組織に所属していないユーザーは組織選択画面にリダイレクト

#### 3.9.2 データアクセス制御

- 全てのクエリに組織IDのフィルターを自動適用
- ユーザーは自分の所属組織のデータのみ閲覧・編集可能

#### 3.9.3 ロールベースのアクセス制御

- 各APIエンドポイントでロールをチェック
- 権限がない場合は403エラーを返す

---

## 4. 案件管理機能

### 4.1 機能概要

1R投資用マンションの売買案件を登録・管理し、決済まで��進捗を追跡する。

### 4.2 案件（Property）の属性

#### 4.2.1 基本情報

| 属性 | 型 | 必須 | 説明 |
|------|-----|------|------|
| id | string | ● | 案件ID（UUID） |
| organizationId | string | ● | 組織ID |
| propertyName | string | ● | 物件名 |
| roomNumber | string | - | 号室 |
| ownerName | string | ● | オーナー名 |
| createdAt | datetime | ● | 作成日時 |
| updatedAt | datetime | ● | 更新日時 |
| createdBy | string | ● | 作成者のユーザーID |

#### 4.2.2 金額情報

| 属性 | 型 | 必須 | 説明 |
|------|-----|------|------|
| aAmount | number | - | A金額（万円単位） |
| exitAmount | number | - | 出口金額（万円単位） |
| commissionFee | number | - | 仲介手数料等（万円単位） |
| profit | number | - | 利益（自動計算）（万円単位） |
| bcDeposit | number | - | BC手付金額（万円単位） |

**利益の自動計算**:

```
profit = exitAmount - aAmount + commissionFee
```

#### 4.2.3 契約情報

| 属性 | 型 | 必須 | 説明 |
|------|-----|------|------|
| contractType | string | - | 契約形態（AB・BC/AC/違約/違約予定/買仲/弁護士） |
| bCompany | string | - | B会社（M'scompany/ライフインベスト/レイジット/取引業者） |
| brokerageCompany | string | - | 仲介会社（レイジット/TOUSEI/アーク/RD/NBF/SHINE TERRACE/エスク/M'scompany） |
| buyerCompany | string | - | 買取業者（自由入力） |
| mortgageBank | string | - | 抵当銀行（自由入力） |
| listType | string | - | 名簿種別 |

#### 4.2.4 日付情報

| 属性 | 型 | 必須 | 説明 |
|------|-----|------|------|
| aContractDate | date | - | A契約日（AB契約日） |
| bcContractDate | date | - | BC契約日 |
| settlementDate | date | - | 決済予定日 |

#### 4.2.5 進捗情報

| 属性 | 型 | 必須 | 説明 |
|------|-----|------|------|
| businessStatus | string | ● | 業務ステータス |
| documentStatus | string | ● | 書類ステータス |

#### 4.2.6 口座情報

| 属性 | 型 | 必須 | 説明 |
|------|-----|------|------|
| accountCompany | string | - | 使用口座会社（レイジット/ライフ/エムズ） |
| bankAccount | string | - | 使用銀行口座 |

#### 4.2.7 その他

| 属性 | 型 | 必須 | 説明 |
|------|-----|------|------|
| remarks | text | - | 備考 |

### 4.3 担当者（Property Assignee）

#### 4.3.1 概要

- 案件には複数の担当者を割り当て可能
- 担当者は組織内のメンバーから選択

#### 4.3.2 属性

| 属性 | 型 | 必須 | 説明 |
|------|-----|------|------|
| id | string | ● | ID（UUID） |
| propertyId | string | ● | 案件ID |
| userId | string | ● | ユーザーID |
| createdAt | datetime | ● | 作成日時 |

### 4.4 業務ステータス（Business Status）

#### 4.4.1 ステータスの定義（7段階）

| 段階 | ステータス | 説明 |
|------|-----------|------|
| 1 | BC確定前 | BC業者が確定していない状態 |
| 2 | BC確定 CB待ち | BC業者確定、重説・BC契約書のチェックバック待ち |
| 3 | BC確定 契約待ち | チェックバック完了、BC契約待ち |
| 4 | BC完了 決済日確定待ち | BC契約完了、決済日未確定 |
| 5 | 決済日確定 精算書待ち | 決済日確定、精算書作成中 |
| 6 | 精算書完了 決済待ち | 精算書完了、決済待ち |
| 7 | 決済完了 | 決済完了 |

#### 4.4.2 ステータス遷移

```
BC確定前
  ↓
BC確定 CB待ち
  ↓
BC確定 契約待ち
  ↓
BC完了 決済日確定待ち
  ↓
決済日確定 精算書待ち
  ↓
精算書完了 決済待ち
  ↓
決済完了
```

### 4.5 書類ステータス（Document Status）

#### 4.5.1 ステータスの定義（3段階）

MVPでは簡略化した3段階のステータスを採用：

| 段階 | ステータス | 説明 |
|------|-----------|------|
| 1 | 書類依頼待ち | 書類取得の依頼前 |
| 2 | 書類取得中 | 書類取得の依頼済み、取得中 |
| 3 | 全書類取得完了 | 全ての必要書類の取得完了 |

**注**: Phase 2以降で、書類ごとの詳細なステータス管理を実装予定

### 4.6 契約進捗（Contract Progress）

#### 4.6.1 概要

案件の契約に関する各種タスクの完了状況を管理する。

#### 4.6.2 AB関係のチェック項目

| 項目 | 説明 |
|------|------|
| 契約書 保存完了 | AB契約書のスキャン・保存完了 |
| 委任状関係 保存完了 | 委任状関係書類の保存完了 |
| 売主身分証 保存完了 | 売主の身分証明書の保存完了 |

#### 4.6.3 BC関係のチェック項目

| 項目 | 説明 |
|------|------|
| BC売契作成 | BC売買契約書の作成完了 |
| 重説作成 | 重要事項説明書の作成完了 |
| BC売契送付 | BC売買契約書の業者への送付完了 |
| 重説送付 | 重要事項説明書の業者への送付完了 |
| BC売契CB完了 | BC売買契約書のチェックバック完了 |
| 重説CB完了 | 重要事項説明書のチェックバック完了 |

#### 4.6.4 データモデル

各チェック項目について以下の情報を記録：

| 属性 | 型 | 必須 | 説明 |
|------|-----|------|------|
| id | string | ● | ID（UUID） |
| propertyId | string | ● | 案件ID |
| checkType | string | ● | チェック項目の種類 |
| isChecked | boolean | ● | チェック済みフラグ |
| checkedAt | datetime | - | チェック日時 |
| checkedBy | string | - | チェックしたユーザーID |

### 4.7 決済進捗（Settlement Progress）

#### 4.7.1 概要

決済に関する各種タスクの完了状況を管理する。

#### 4.7.2 精算書関係

##### BC精算書

段階進捗バッジで管理（4段階）：

1. 未作成
2. 作成
3. 送付
4. CB完了

##### AB精算書

段階進捗バッジで管理（4段階）：

1. 未作成
2. 作成
3. 送付
4. CR完了

##### ローン計算書

チェックボックスで管理：

- ローン計算書 保存

#### 4.7.3 司法書士関係

| 項目 | 管理方法 |
|------|---------|
| 司法書士依頼 | チェックボックス |
| 必要書類共有 | チェックボックス |
| 本人確認書類 | 段階進捗バッジ（発送 > 受取 > 返送） |
| 書類不備なし | チェックボックス |

#### 4.7.4 抵当銀行関係

| 項目 | 管理方法 |
|------|---------|
| 抵当銀行 | 段階進捗バッジ（依頼 > 受付完了） |
| 書類不備なし | チェックボックス |
| ローン計算書 保存 | チェックボックス |
| 売主手出し完了 | チェックボックス |

#### 4.7.5 賃貸管理・決済後関係

| 項目 | 管理方法 |
|------|---------|
| 管理解約依頼 | 段階進捗バッジ（依頼 > 完了） |
| 保証会社承継 | 段階進捗バッジ（依頼 > 完了） |
| 鍵 | 段階進捗バッジ（受取 > 発送） |
| 管積 口座振替手続き | 段階進捗バッジ（受取 > 発送） |
| 取引台帳記入 | チェックボックス |

#### 4.7.6 データモデル

##### チェックボックス項目

| 属性 | 型 | 必須 | 説明 |
|------|-----|------|------|
| id | string | ● | ID（UUID） |
| propertyId | string | ● | 案件ID |
| checkType | string | ● | チェック項目の種類 |
| isChecked | boolean | ● | チェック済みフラグ |
| checkedAt | datetime | - | チェック日時 |
| checkedBy | string | - | チェックしたユーザーID |

##### 段階進捗項目

| 属性 | 型 | 必須 | 説明 |
|------|-----|------|------|
| id | string | ● | ID（UUID） |
| propertyId | string | ● | 案件ID |
| progressType | string | ● | 進捗項目の種類 |
| currentStage | number | ● | 現在の段階（0〜最大段階） |
| updatedAt | datetime | ● | 更新日時 |
| updatedBy | string | ● | 更新したユーザーID |

### 4.8 案件一覧画面

#### 4.8.1 BC確定前案件一覧

**URL**: `/properties/unconfirmed`

**目的**: BC確定前の案件を一覧表示し、進捗を管理する

**表示項目**（15項目）:

| # | 項目 | 説明 |
|---|------|------|
| 1 | 担当 | 担当者名（複数、バッジ表示） |
| 2 | 物件名 | 物件の名称 |
| 3 | 号室 | 部屋番号 |
| 4 | オーナー | オーナー名 |
| 5 | A金額 | 入口金額（万円単位） |
| 6 | 出口 | 出口金額（万円単位） |
| 7 | 仲手等 | 仲介手数料等（万円単位） |
| 8 | 利益 | 自動計算された利益額（万円単位） |
| 9 | 契約形態 | 契約の形態（最大5文字表示） |
| 10 | B会社 | B会社名（最大5文字表示） |
| 11 | 仲介 | 仲介会社名（最大5文字表示） |
| 12 | 進捗 | 業務ステータス（最大6文字に短縮表示） |
| 13 | 書類 | 書類ステータス（最大6文字に短縮表示） |
| 14 | 備考 | メモ・注意事項 |
| 15 | 操作 | 詳細・編集メニュー |

**フィルター条件**:
- 業務ステータスが「BC確定前」の案件のみ表示

**画面上部の集計表示**:
- 利益見込み合計
- A金額合計
- 件数

**主な機能**:
- 案件のインライン編集（進捗、書類、備考）
- 案件の詳細表示
- 案件の編集（モーダル）
- 案件の削除
- ソート・フィルター

#### 4.8.2 月次案件一覧

**URL**: `/properties/monthly/{year}/{month}`

**目的**: 指定月の決済予定案件および決済完了案件を表示

**タブ構成**:

| タブ名 | 対象案件 |
|--------|---------|
| 業者確定後 | BC確定後〜決済待ちまでの案件 |
| 決済完了 | 決済完了済みの案件 |

**タブ1: 業者確定後**

集計表示（上部）:
- 利益合計
- BC手付合計
- 件数

口座別決済日集計:
- 決済日（曜日付き表示）
- 出口金額合計（万円単位）
- 件数
- 上限比率（1億円に対する割合）
  - 80%以上: 赤色 + ⚠️アイコン
  - 50%以上: 黄色
  - 50%未満: 青色

案件一覧テーブル（18項目）:

| # | 項目 | 説明 |
|---|------|------|
| 1 | 担当 | 担当者名（複数、バッジ表示） |
| 2 | 物件名 | 物件の名称 |
| 3 | 号室 | 部屋番号 |
| 4 | オーナー | オーナー名 |
| 5 | A金額 | 入口金額（万円単位） |
| 6 | 出口 | 出口金額（万円単位） |
| 7 | 仲手等 | 仲介手数料等（万円単位） |
| 8 | 利益 | 自動計算された利益額（万円単位） |
| 9 | BC手付 | BC手付金額（万円単位） |
| 10 | 決済日 | 決済予定日（M/D形式） |
| 11 | 買取 | 買取会社名（最大5文字表示） |
| 12 | 契約形態 | 契約の形態（最大5文字表示） |
| 13 | B会社 | B会社名（最大5文字表示） |
| 14 | 仲介 | 仲介会社名（最大5文字表示） |
| 15 | 進捗 | 業務ステータス（最大6文字に短縮表示） |
| 16 | 書類 | 書類ステータス（最大6文字に短縮表示） |
| 17 | 備考 | メモ・注意事項 |
| 18 | 操作 | 詳細・編集メニュー |

**フィルター条件**:
- 決済日が選択月の範囲内
- 業務ステータスが「BC確定前」以外

**タブ2: 決済完了**

集計表示（上部）:
- 利益合計
- BC手付合計
- 件数

案件一覧テーブル:
- 業者確定後タブと同じ項目を表示
- 進捗ステータスは全て「決済完了」

**フィルター条件**:
- 決済日が選択月の範囲内
- 業務ステータスが「決済完了」

### 4.9 案件詳細画面

**URL**: `/properties/{id}`

**目的**: 案件の全情報を閲覧専用で表示

**レイアウト**: 2カラムレイアウト

**左カラム（2/3幅）**:

- 金額情報セクション
  - 入口金額（A金額）
  - 出口金額
  - 仲介手数料
  - BC手付
  - 利益見込み（強調表示）

- 契約スケジュールセクション
  - A契約日（AB契約日）
  - BC契約日
  - 決済予定日

- 契約進捗セクション
  - AB関係のチェック項目
  - BC関係のチェック項目

**右カラム（1/3幅）**:

- 関係者セクション
  - 契約形態
  - 買取業者
  - B会社
  - 仲介会社
  - 抵当銀行

- 口座情報セクション
  - 使用口座会社
  - 使用銀行口座

- その他セクション
  - 名簿種別
  - 備考

### 4.10 案件編集モーダル

**目的**: 案件情報を編集する

**モーダルサイズ**: 幅60vw、最大高さ90vh、スクロール可能

**タブ構成**: 4タブ

#### 4.10.1 タブ1: 基本情報

2カラムレイアウト（項目によって1カラム）

| 項目 | 入力形式 | 必須 |
|------|---------|------|
| 担当 | マルチセレクト | ● |
| 物件名 | テキスト | ● |
| 号室 | テキスト | - |
| オーナー名 | テキスト | ● |
| A金額 | 数値（万円） | - |
| 出口金額 | 数値（万円） | - |
| 仲手等 | 数値（万円） | - |
| 利益 | 自動計算（読み取り専用） | - |
| A契約日 | 日付入力 | - |
| 決済日 | 日付入力 | - |
| 買取業者 | テキスト（候補付き） | - |
| 契約形態 | プルダウン | - |
| B会社 | プルダウン | - |
| 仲介会社 | プルダウン | - |
| 抵当銀行 | テキスト（候補付き） | - |
| 名簿種別 | テキスト | - |
| 備考 | テキストエリア（3行） | - |

#### 4.10.2 タブ2: 契約進捗

AB関係セクション:
- 契約書 保存完了（チェックボックス）
- 委任状関係 保存完了（チェックボックス）
- 売主身分証 保存完了（チェックボックス）

BC関係セクション:
- BC売契作成（チェックボックス）
- 重説作成（チェックボックス）
- BC売契送付（チェックボックス）
- 重説送付（チェックボックス）
- BC売契CB完了（チェックボックス）
- 重説CB完了（チェックボックス）

**チェック済みの場合**: 日時とユーザー名を表示

#### 4.10.3 タブ3: 書類進捗

MVPでは簡易版を実装：

- 書類ステータスの選択（3段階）
  - 書類依頼待ち
  - 書類取得中
  - 全書類取得完了

**注**: Phase 2以降で、書類ごとの詳細なステータス管理を実装予定

#### 4.10.4 タブ4: 決済進捗

2カラムレイアウト

**左カラム**:

- 精算書関係セクション
  - BC精算書（段階進捗バッジ）
  - ローン計算書 保存（チェックボックス）
  - AB精算書（段階進捗バッジ）

- 司法書士関係セクション
  - 司法書士依頼（チェックボックス）
  - 必要書類共有（チェックボックス）
  - 本人確認書類（段階進捗バッジ）
  - 書類不備なし（チェックボックス）

- 抵当銀行関係セクション
  - 抵当銀行（段階進捗バッジ）
  - 書類不備なし（チェックボックス）
  - ローン計算書 保存（チェックボックス）
  - 売主手出し完了（チェックボックス）

- 賃貸管理・決済後関係セクション
  - 管理解約依頼（段階進捗バッジ）
  - 保証会社承継（段階進捗バッジ）
  - 鍵（段階進捗バッジ）
  - 管積 口座振替手続き（段階進捗バッジ）
  - 取引台帳記入（チェックボックス）

**右カラム**:

- 口座情報セクション
  - 使用口座会社（プルダウン）
  - 使用銀行口座（プルダウン）

- 同日同口座の出口金額合計表示
  - 1億円を超える場合は警告表示

**フッター部**:
- キャンセルボタン
- 保存ボタン

### 4.11 案件作成機能

**アクセス**: BC確定前案件一覧画面、または月次案件一覧画面の「新規作成」ボタン

**入力方法**: 案件編集モーダルと同じフォームを使用

**必須項目**:
- 担当（最低1名）
- 物件名
- オーナー名

**初期値**:
- 業務ステータス: BC確定前
- 書類ステータス: 書類依頼待ち
- その他のチェック項目: 全て未チェック

### 4.12 案件削除機能

**アクセス**: 案件一覧画面の操作メニュー

**確認ダイアログ**: 削除前に確認ダイアログを表示

**権限**: owner、admin、案件の作成者のみ削除可能

**ソフトデリート**: 実装せず、物理削除を行う（MVPのため）

---

## 5. データモデル

### 5.1 テーブル一覧

| テーブル名 | 説明 |
|-----------|------|
| user | ユーザー |
| session | セッション |
| account | アカウント（OAuth用） |
| verification | メール認証 |
| organization | 組織 |
| member | 組織メンバー |
| invitation | 組織への招待 |
| property | 案件 |
| propertyAssignee | 案件担当者 |
| contractProgress | 契約進捗（チェック項目） |
| settlementProgress | 決済進捗（チェック項目） |
| settlementStageProgress | 決済進捗（段階進捗項目） |

### 5.2 主要テーブルの詳細

#### 5.2.1 user テーブル

Better Authの標準スキーマを使用

| カラム | 型 | 制約 | 説明 |
|--------|-----|------|------|
| id | text | PK | ユーザーID |
| email | text | UNIQUE, NOT NULL | メールアドレス |
| emailVerified | boolean | NOT NULL, DEFAULT false | メール認証済みフラグ |
| name | text | NOT NULL | 氏名 |
| image | text | - | プロフィール画像URL |
| createdAt | integer | NOT NULL | 作成日時（Unix timestamp） |
| updatedAt | integer | NOT NULL | 更新日時（Unix timestamp） |

#### 5.2.2 organization テーブル

| カラム | 型 | 制約 | 説明 |
|--------|-----|------|------|
| id | text | PK | 組織ID |
| name | text | NOT NULL | 組織名 |
| slug | text | UNIQUE, NOT NULL | 組織のスラッグ |
| createdAt | integer | NOT NULL | 作成日時（Unix timestamp） |
| updatedAt | integer | NOT NULL | 更新日時（Unix timestamp） |

#### 5.2.3 member テーブル

| カラム | 型 | 制約 | 説明 |
|--------|-----|------|------|
| id | text | PK | メンバーID |
| organizationId | text | NOT NULL, FK | 組織ID |
| userId | text | NOT NULL, FK | ユーザーID |
| role | text | NOT NULL | ロール（owner/admin/member） |
| createdAt | integer | NOT NULL | 作成日時（Unix timestamp） |
| updatedAt | integer | NOT NULL | 更新日時（Unix timestamp） |

**インデックス**:
- UNIQUE(organizationId, userId)

#### 5.2.4 property テーブル

| カラム | 型 | 制約 | 説明 |
|--------|-----|------|------|
| id | text | PK | 案件ID |
| organizationId | text | NOT NULL, FK | 組織ID |
| propertyName | text | NOT NULL | 物件名 |
| roomNumber | text | - | 号室 |
| ownerName | text | NOT NULL | オーナー名 |
| aAmount | real | - | A金額（万円） |
| exitAmount | real | - | 出口金額（万円） |
| commissionFee | real | - | 仲介手数料等（万円） |
| profit | real | - | 利益（万円） |
| bcDeposit | real | - | BC手付金額（万円） |
| contractType | text | - | 契約形態 |
| bCompany | text | - | B会社 |
| brokerageCompany | text | - | 仲介会社 |
| buyerCompany | text | - | 買取業者 |
| mortgageBank | text | - | 抵当銀行 |
| listType | text | - | 名簿種別 |
| aContractDate | integer | - | A契約日（Unix timestamp） |
| bcContractDate | integer | - | BC契約日（Unix timestamp） |
| settlementDate | integer | - | 決済予定日（Unix timestamp） |
| businessStatus | text | NOT NULL | 業務ステータス |
| documentStatus | text | NOT NULL | 書類ステータス |
| accountCompany | text | - | 使用口座会社 |
| bankAccount | text | - | 使用銀行口座 |
| remarks | text | - | 備考 |
| createdAt | integer | NOT NULL | 作成日時（Unix timestamp） |
| updatedAt | integer | NOT NULL | 更新日時（Unix timestamp） |
| createdBy | text | NOT NULL, FK | 作成者のユーザーID |

**インデックス**:
- organizationId
- businessStatus
- settlementDate

#### 5.2.5 propertyAssignee テーブル

| カラム | 型 | 制約 | 説明 |
|--------|-----|------|------|
| id | text | PK | ID |
| propertyId | text | NOT NULL, FK | 案件ID |
| userId | text | NOT NULL, FK | ユーザーID |
| createdAt | integer | NOT NULL | 作成日時（Unix timestamp） |

**インデックス**:
- UNIQUE(propertyId, userId)

#### 5.2.6 contractProgress テーブル

| カラム | 型 | 制約 | 説明 |
|--------|-----|------|------|
| id | text | PK | ID |
| propertyId | text | NOT NULL, FK | 案件ID |
| checkType | text | NOT NULL | チェック項目の種類 |
| isChecked | boolean | NOT NULL, DEFAULT false | チェック済みフラグ |
| checkedAt | integer | - | チェック日時（Unix timestamp） |
| checkedBy | text | -, FK | チェックしたユーザーID |

**インデックス**:
- UNIQUE(propertyId, checkType)

**checkTypeの値**:
- ab_contract_saved
- ab_power_of_attorney_saved
- ab_seller_id_saved
- bc_contract_created
- bc_explanation_created
- bc_contract_sent
- bc_explanation_sent
- bc_contract_cb_completed
- bc_explanation_cb_completed

#### 5.2.7 settlementProgress テーブル

| カラム | 型 | 制約 | 説明 |
|--------|-----|------|------|
| id | text | PK | ID |
| propertyId | text | NOT NULL, FK | 案件ID |
| checkType | text | NOT NULL | チェック項目の種類 |
| isChecked | boolean | NOT NULL, DEFAULT false | チェック済みフラグ |
| checkedAt | integer | - | チェック日時（Unix timestamp） |
| checkedBy | text | -, FK | チェックしたユーザーID |

**インデックス**:
- UNIQUE(propertyId, checkType)

**checkTypeの値**:
- loan_calculation_saved
- judicial_scrivener_requested
- necessary_documents_shared
- documents_no_defects
- mortgage_bank_documents_no_defects
- mortgage_bank_loan_calculation_saved
- seller_payment_completed
- transaction_ledger_entered

#### 5.2.8 settlementStageProgress テーブル

| カラム | 型 | 制約 | 説明 |
|--------|-----|------|------|
| id | text | PK | ID |
| propertyId | text | NOT NULL, FK | 案件ID |
| progressType | text | NOT NULL | 進捗項目の種類 |
| currentStage | integer | NOT NULL, DEFAULT 0 | 現在の段階 |
| updatedAt | integer | NOT NULL | 更新日時（Unix timestamp） |
| updatedBy | text | NOT NULL, FK | 更新したユーザーID |

**インデックス**:
- UNIQUE(propertyId, progressType)

**progressTypeの値と段階数**:
- bc_settlement_statement: 0〜3（未作成/作成/送付/CB完了）
- ab_settlement_statement: 0〜3（未作成/作成/送付/CR完了）
- identity_confirmation_documents: 0〜3（未発送/発送/受取/返送）
- mortgage_bank: 0〜2（未依頼/依頼/受付完了）
- management_cancellation: 0〜2（未依頼/依頼/完了）
- guarantee_company_succession: 0〜2（未依頼/依頼/完了）
- keys: 0〜2（未受取/受取/発送）
- management_reserve_account_transfer: 0〜2（未受取/受取/発送）

---

## 6. 技術スタック

### 6.1 フロントエンド

- **フレームワーク**: Next.js 15 (App Router)
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS v4
- **UIコンポーネント**: shadcn/ui
- **状態管理**: React Context API、SWR

### 6.2 バックエンド

- **フレームワーク**: Next.js 15 (App Router)
- **言語**: TypeScript
- **ORM**: Drizzle ORM
- **認証**: Better Auth

### 6.3 データベース

- **データベース**: Turso (SQLite Edge Database)
- **接続**: libSQL

### 6.4 インフラ

- **ホスティング**: Vercel
- **環境変数管理**: Vercel Environment Variables

---

## 7. 非機能要件

### 7.1 パフォーマンス

- ページ読み込み速度: 3秒以内
- データ検索速度: 1秒以内
- 案件一覧表示: 100件まで快適に表示

### 7.2 セキュリティ

- HTTPS通信の強制
- CSRF対策（Next.jsの標準機能を使用）
- XSS対策（React/Next.jsの標準機能を使用）
- パスワードのハッシュ化（Better Authの標準機能を使用）
- セッションの有効期限管理
- 組織単位でのデータ分離
- ロールベースのアクセス制御

### 7.3 可用性

- 稼働率: 99%以上（Vercelの標準SLA）

### 7.4 保守性

- TypeScriptによる型安全性
- コードの可読性を重視
- コンポーネントの再利用性
- エラーログの記録

### 7.5 使いやすさ

- レスポンシブデザイン（PC優先、モバイル対応は最低限）
- 直感的なUI/UX
- ローディング状態の表示
- エラーメッセージの分かりやすい表示

---

## 8. 画面遷移

### 8.1 認証フロー

```
未認証
  ↓
ログイン画面 (/sign-in)
  ↓
[認証成功]
  ↓
組織選択画面 (/select-organization) ※複数組織に所属している場合のみ
  ↓
ダッシュボード (/)
```

### 8.2 案件管理フロー

```
ダッシュボード (/)
  ↓
├─ BC確定前案件一覧 (/properties/unconfirmed)
│    ↓
│    ├─ 案件詳細 (/properties/{id})
│    │    ↓
│    │    └─ 案件編集モーダル
│    │
│    └─ 案件作成モーダル
│
└─ 月次案件一覧 (/properties/monthly/{year}/{month})
     ↓
     ├─ 案件詳細 (/properties/{id})
     │    ↓
     │    └─ 案件編集モーダル
     │
     └─ 案件作成モーダル
```

### 8.3 組織管理フロー

```
ダッシュボード (/)
  ↓
組織設定 (/settings/organization)
  ↓
  ├─ 組織情報編集
  │
  ├─ メンバー一覧
  │    ↓
  │    ├─ メンバー招待
  │    │
  │    ├─ メンバーのロール変更
  │    │
  │    └─ メンバーの削除
  │
  └─ 組織削除（owner のみ）
```

---

## 9. API設計

### 9.1 認証API

| エンドポイント | メソッド | 説明 |
|--------------|---------|------|
| /api/auth/sign-up | POST | ユーザー登録 |
| /api/auth/sign-in | POST | ログイン |
| /api/auth/sign-out | POST | ログアウト |
| /api/auth/session | GET | セッション取得 |
| /api/auth/reset-password | POST | パスワードリセット |

**注**: Better Authの標準APIを使用

### 9.2 組織API

| エンドポイント | メソッド | 説明 | 権限 |
|--------------|---------|------|------|
| /api/organization | GET | 組織一覧取得 | - |
| /api/organization | POST | 組織作成 | - |
| /api/organization/{id} | GET | 組織詳細取得 | member以上 |
| /api/organization/{id} | PUT | 組織更新 | admin以上 |
| /api/organization/{id} | DELETE | 組織削除 | owner |
| /api/organization/{id}/members | GET | メンバー一覧取得 | member以上 |
| /api/organization/{id}/members | POST | メンバー招待 | admin以上 |
| /api/organization/{id}/members/{memberId} | PUT | メンバー更新（ロール変更） | admin以上 |
| /api/organization/{id}/members/{memberId} | DELETE | メンバー削除 | admin以上 |

### 9.3 案件API

| エンドポイント | メソッド | 説明 | 権限 |
|--------------|---------|------|------|
| /api/properties | GET | 案件一覧取得 | member以上 |
| /api/properties | POST | 案件作成 | member以上 |
| /api/properties/{id} | GET | 案件詳細取得 | member以上 |
| /api/properties/{id} | PUT | 案件更新 | member以上 |
| /api/properties/{id} | DELETE | 案件削除 | 作成者/admin以上 |
| /api/properties/{id}/assignees | GET | 担当者一覧取得 | member以上 |
| /api/properties/{id}/assignees | POST | 担当者追加 | member以上 |
| /api/properties/{id}/assignees/{assigneeId} | DELETE | 担当者削除 | member以上 |
| /api/properties/{id}/contract-progress | GET | 契約進捗取得 | member以上 |
| /api/properties/{id}/contract-progress | PUT | 契約進捗更新 | member以上 |
| /api/properties/{id}/settlement-progress | GET | 決済進捗取得 | member以上 |
| /api/properties/{id}/settlement-progress | PUT | 決済進捗更新 | member以上 |

**クエリパラメータ（案件一覧取得）**:
- businessStatus: 業務ステータスでフィルター
- settlementDateFrom: 決済日の開始日
- settlementDateTo: 決済日の終了日
- assigneeId: 担当者IDでフィルター
- sortBy: ソート項目（createdAt/settlementDate/profit）
- sortOrder: ソート順（asc/desc）

---

## 10. 開発フェーズ

### 10.1 Phase 1（第1〜2週）

#### 環境構築・認証機能

- [ ] プロジェクトセットアップ
- [ ] Tursoデータベースの作成
- [ ] Better Authの設定
- [ ] 認証画面の実装
  - [ ] ログイン画面
  - [ ] サインアップ画面
  - [ ] パスワードリセット画面
- [ ] 組織管理機能の実装
  - [ ] 組織作成
  - [ ] 組織選択画面
  - [ ] メンバー招待機能
  - [ ] メンバー管理画面

#### 案件管理の基本機能

- [ ] データモデルの実装（Drizzle Schema）
- [ ] 案件CRUDのAPI実装
- [ ] 案件一覧画面の実装（BC確定前）
  - [ ] 基本的なテーブル表示
  - [ ] フィルター・ソート機能
  - [ ] 集計表示
- [ ] 案件詳細画面の実装
- [ ] 案件編集モーダルの実装（タブ1: 基本情報）

### 10.2 Phase 2（第3〜4週）

#### 案件管理の応用機能

- [ ] 担当者管理機能の実装
- [ ] 案件編集モーダルの実装（タブ2: 契約進捗）
- [ ] 案件編集モーダルの実装（タブ3: 書類進捗）
- [ ] 案件編集モーダルの実装（タブ4: 決済進捗）
- [ ] 月次案件一覧画面の実装
  - [ ] 業者確定後タブ
  - [ ] 決済完了タブ
  - [ ] 口座別決済日集計
  - [ ] 1億円上限警告

#### テスト・デプロイ

- [ ] 単体テストの作成
- [ ] E2Eテストの作成
- [ ] Vercelへのデプロイ
- [ ] 本番環境の動作確認

---

## 11. 成功指標（KPI）

### 11.1 定量指標

- **ユーザー登録数**: 10組織以上
- **案件登録数**: 100件以上
- **アクティブユーザー数**: 週1回以上ログイン
- **ページ読み込み速度**: 平均3秒以内
- **エラー率**: 1%以下

### 11.2 定性指標

- **使いやすさ**: ユーザーフィードバックで「使いやすい」と評価される
- **業務効率化**: 従来のスプレッドシート管理と比較して作業時間が短縮される
- **データの正確性**: 入力ミスや漏れが減少する

---

## 12. リスクと対策

### 12.1 技術的リスク

| リスク | 影響 | 対策 |
|--------|------|------|
| Tursoの性能不足 | システムが遅くなる | インデックスの最適化、クエリの改善 |
| Better Authの不具合 | 認証ができない | 公式ドキュメントを参照、コミュニティに質問 |
| Vercelのデプロイエラー | リリースできない | ローカルでビルド確認、エラーログを確認 |

### 12.2 スケジュールリスク

| リスク | 影響 | 対策 |
|--------|------|------|
| 要件の追加・変更 | スケジュール遅延 | MVPの範囲を厳守、Phase 2以降に回す |
| 実装の複雑化 | 開発期間の延長 | シンプルな実装を優先、リファクタリングは後回し |

### 12.3 ビジネスリスク

| リスク | 影響 | 対策 |
|--------|------|------|
| ユーザーの受け入れ不足 | 利用されない | ユーザーインタビュー、フィードバックの収集 |
| データ移行の失敗 | 既存データが使えない | データ移行ツールの作成、テスト環境での検証 |

---

## 13. 将来の拡張性（Phase 2以降）

### 13.1 Phase 2で追加予定の機能

- マイソク作成・業者配布機能
- 営業・事務員連携機能（依頼管理）
- 書類アップロード・管理機能
- 書類ステータスの詳細化（5段階）
- チェックバックループの可視化
- アラート・リマインダー機能

### 13.2 Phase 3以降で追加予定の機能

- レポート・分析機能
- ダッシュボードの充実
- 外部システムとの連携（会計システム、メール等）
- モバイルアプリ化
- AI機能（予測、自動査定等）

---

## 14. 制約事項

### 14.1 技術的制約

- Turso（SQLite）の制限
  - 複雑なJOINクエリは避ける
  - トランザクションは最小限にする
- Vercelの制限
  - サーバーレス関数の実行時間制限（10秒）
  - ファイルサイズ制限（4.5MB）

### 14.2 ビジネス的制約

- MVPは最小限の機能のみ実装
- Phase 2以降の機能は含めない
- 既存のスプレッドシート・Evernoteからのデータ移行は手動

---

## 15. 用語集

| 用語 | 説明 |
|------|------|
| 物上げ | 既存オーナーへの売却営業 |
| A金額 | 入口金額（AB間の売買代金） |
| 出口金額 | BC間の売買代金 |
| 仲手 | 仲介手数料 |
| マイソク | 物件資料 |
| BC | BからCへの取引 |
| AB | AからBへの取引 |
| CB | チェックバック（業者からの内容確認） |
| CR | チェックリスト（上席からの内容確認） |
| 重説 | 重要事項説明書 |
| 賃契 | 賃貸借契約書 |
| 重調 | 重要事項調査報告書 |
| 長計 | 長期修繕計画書 |
| 公課証明 | 固定資産税評価証明書 |

---

最終更新: 2025-10-14
